<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relaxation Room ‚Äî AR/VR</title>

  <!-- A-Frame (WebXR) -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  

  <style>
    /* Page + UI */
    html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .ui {
      position: absolute;
      z-index: 10;
      left: 20px;
      top: 20px;
      display: flex;
      gap: 12px;
      align-items:center;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.08);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 30px rgba(3, 6, 23, 0.45);
      display:flex;
      gap:8px;
      align-items:center;
    }

    .title {
      font-weight:700; font-size:14px;
    }

    button.btn {
      background: linear-gradient(90deg,#7c3aed,#ec4899);
      color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer;
      font-weight:600; font-size:13px;
      box-shadow: 0 6px 18px rgba(124,58,237,0.25);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    button.btn:active { transform: translateY(1px) scale(.99); }
    select, .toggle {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      color: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      font-weight:600;
    }

    /* Bottom right controls */
    .bottom-controls {
      position: absolute; right: 20px; bottom: 20px; z-index:10; display:flex; gap:12px; align-items:center;
    }
    .small {
      padding:8px 10px; font-size:13px;
      background: rgba(255,255,255,0.06);
      border-radius:10px; color:#fff; border: 1px solid rgba(255,255,255,0.05);
    }

    /* Guided breathing overlay */
    .breath-overlay {
      position: absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      z-index:9;
      display:flex; flex-direction: column; align-items:center; gap:14px;
      pointer-events:none;
    }
    .breath-circle {
      width: 160px; height:160px; border-radius:50%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      border: 2px solid rgba(255,255,255,0.12);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 20px 50px rgba(2,6,23,0.5);
      transition: transform 3s ease;
      pointer-events: none;
    }
    .breath-text {
      color:#fff; font-weight:700; font-size:20px; text-shadow: 0 6px 20px rgba(0,0,0,0.5);
      pointer-events:none;
    }

    /* instructions bubble */
    .help {
      position:absolute; left:50%; transform:translateX(-50%); top:10px; z-index:10;
      background: rgba(0,0,0,0.35); color:#fff; padding:8px 14px; border-radius:10px;
      backdrop-filter: blur(6px); font-weight:600; font-size:13px;
    }

    /* small screen adapt */
    @media (max-width:720px) {
      .ui { left: 12px; top:12px; }
      .card { padding:8px 10px; }
      .breath-circle { width:120px; height:120px; }
    }
  </style>
</head>
<body>
  <!-- small top help -->
  <div class="help">Click environment ‚Üí press VR button to enter headset (if supported). Use guided breathing for 3 min.</div>

  <!-- UI: env selector + audio + center -->
  <div class="ui">
    <div class="card">
      <div style="display:flex;flex-direction:column">
        <div class="title">Environment</div>
        <select id="envSelect" class="small" aria-label="Environment selector">
          <option value="beach">Beach Sunrise</option>
          <option value="forest">Forest Meadow</option>
          <option value="night">Night Sky</option>
        </select>
      </div>
      <button id="recenterBtn" class="btn" title="Recenter">Recenter</button>
    </div>

    <div class="card">
      <div style="display:flex;flex-direction:column">
        <div class="title">Ambient</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="audioPlay" class="small">Play</button>
          <button id="audioPause" class="small">Pause</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;flex-direction:column">
        <div class="title">Guided Breathing</div>
        <button id="startBreath" class="btn">Start</button>
      </div>
    </div>
  </div>

  <!-- Bottom small controls -->
  <div class="bottom-controls">
    <div class="card small">‚è±Ô∏è Session: <span id="sessionTime">0:00</span></div>
    <div class="card small">üå°Ô∏è Calmness: <span id="calmness">‚Äî</span></div>
  </div>

  <!-- Guided breathing overlay -->
  <div class="breath-overlay" id="breathOverlay" style="display:none;">
    <div class="breath-circle" id="breathCircle"></div>
    <div class="breath-text" id="breathText">Ready</div>
  </div>

  <!-- A-Frame Scene -->
  <a-scene id="scene" vr-mode-ui="enterVRButton: true" background="color: #000000">
    <!-- Camera rig with orbit controls when on desktop -->
    <a-entity id="rig" position="0 1.6 3">
      <a-entity camera look-controls wasd-controls></a-entity>
    </a-entity>

    <!-- Lighting -->
    <a-entity light="type: ambient; intensity: 0.6; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 0.5" position="-1 2 1"></a-entity>

    <!-- Ground (reflective subtle) -->
    <a-plane id="ground" rotation="-90 0 0" width="40" height="40" color="#3a6" roughness="1" position="0 0 0"></a-plane>

    <!-- Environment entities: we'll toggle visibility -->
    <!-- Beach: gentle waves simulated by wavy plane -->
    <a-entity id="env-beach">
      <a-sky id="sky-beach" color="#FFCC99"></a-sky>
      <a-plane rotation="-90 0 0" width="40" height="40" position="0 0 0" color="#e8d5b5"></a-plane>
      <a-entity id="sun" geometry="primitive: sphere; radius: 1.2" material="color:#FFD27D; shader: flat" position="0 6 -8" animation="property: position; to: 0 5 -6; dur: 8000; dir: alternate; loop: true"></a-entity>
      <!-- subtle cloud -->
      <a-entity position="-2 3 -4" animation="property: position; to: 2 3 -4; dur: 22000; loop: true; easing: linear">
        <a-sphere radius="0.9" color="#fff" opacity="0.6"></a-sphere>
        <a-sphere radius="0.6" position="1 0 0.2" color="#fff" opacity="0.6"></a-sphere>
      </a-entity>
    </a-entity>

    <!-- Forest -->
    <a-entity id="env-forest" visible="false">
      <a-sky color="#88D19F"></a-sky>
      <a-plane rotation="-90 0 0" width="40" height="40" position="0 0 0" color="#2e7d32"></a-plane>
      <!-- some stylized trees -->
      <a-entity position="-3 0 -5">
        <a-cylinder height="2" radius="0.12" color="#5d4037" position="0 1 0"></a-cylinder>
        <a-cone height="2" radius-bottom="1.0" color="#2e7d32" position="0 2 0"></a-cone>
      </a-entity>
      <a-entity position="2 0 -4" animation="property: rotation; to: 0 360 0; dur: 30000; loop: true; easing: linear">
        <a-cylinder height="2.2" radius="0.12" color="#5d4037" position="0 1 0"></a-cylinder>
        <a-cone height="2.2" radius-bottom="1.1" color="#388e3c" position="0 2 0.1"></a-cone>
      </a-entity>
      <!-- soft mist -->
      <a-entity particle-system="preset: dust; color: #ffffff; particleCount: 50; size: 0.2" position="0 1.5 -2"></a-entity>
    </a-entity>

    <!-- Night sky -->
    <a-entity id="env-night" visible="false">
      <a-sky color="#081229"></a-sky>
      <a-entity id="stars">
        <!-- many tiny stars -->
        <a-sphere v-for="i in 40" radius="0.02" position="${Math.random()*40-20} ${Math.random()*8+1} ${Math.random()*-40}" color="#fff" opacity="0.9"></a-sphere>
      </a-entity>
      <a-entity position="0 2 -6">
        <a-plane width="6" height="1.6" position="0 0 0" color="#0b1220" opacity="0.4"></a-plane>
        <a-text value="Stargaze and breathe" color="#fff" align="center" position="0 0 -0.01"></a-text>
      </a-entity>
    </a-entity>

    <!-- Floating info panel for headset users (hidden in desktop) -->
    <a-entity id="panel" position="0 1.8 -1.6" visible="false">
      <a-plane width="1.6" height="0.6" color="#000" opacity="0.35" border="radius:0.05"></a-plane>
      <a-text value="Relaxation Room" color="#fff" align="center" position="0 0.12 -0.01"></a-text>
      <a-text id="panelLine" value="Take 3 minutes to breathe" color="#ddd" align="center" position="0 -0.08 -0.01" width="1.4"></a-text>
    </a-entity>

    <!-- audio entity (we will control via JS) -->
    <a-entity id="amb-audio" position="0 1.6 0">
      <a-sound id="ambientSound" src="#ambientAudio" autoplay="false" loop="true" volume="0.6"></a-sound>
    </a-entity>

    <!-- asset management -->
    <a-assets>
      <!-- small gentle chime or ambient can be added by URL; commented out for offline:
      <audio id="ambientAudio" src="https://cdn.example.org/ambient.mp3"></audio>
      -->
      <!-- If no audio asset is present, A-Frame ignores it; we will use WebAudio fallback in JS -->
    </a-assets>
  </a-scene>

  <script>
    // Simple scene manager
    const envSelect = document.getElementById('envSelect');
    const beach = document.getElementById('env-beach');
    const forest = document.getElementById('env-forest');
    const night = document.getElementById('env-night');
    const recenterBtn = document.getElementById('recenterBtn');

    function setEnv(name) {
      beach.setAttribute('visible', name === 'beach');
      forest.setAttribute('visible', name === 'forest');
      night.setAttribute('visible', name === 'night');

      // adjust ground color for visual coherence
      const ground = document.getElementById('ground');
      if (name === 'beach') ground.setAttribute('color','#e8d5b5');
      if (name === 'forest') ground.setAttribute('color','#2e7d32');
      if (name === 'night') ground.setAttribute('color','#081229');
    }

    envSelect.addEventListener('change', e => setEnv(e.target.value));
    setEnv(envSelect.value);

    // Recenter: move rig to nicer vantage or reorient camera
    recenterBtn.addEventListener('click', () => {
      const rig = document.getElementById('rig');
      rig.setAttribute('position','0 1.6 3');
      // small visual feedback
      recenterBtn.innerText = 'Recentred!';
      setTimeout(()=> recenterBtn.innerText = 'Recenter', 1000);
    });

    // Ambient audio via WebAudio (fallback safe)
    let audioCtx, audioEl, audioBuffer, audioSource;
    let isPlaying = false;
    const audioPlay = document.getElementById('audioPlay');
    const audioPause = document.getElementById('audioPause');

    // we use a tiny generated ambient tone to avoid external assets
    function initAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = 220; // base tone
        gain.gain.value = 0.02; // very soft
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        audioSource = {osc, gain};
      } catch (e) {
        console.warn('Audio not supported', e);
      }
    }

    audioPlay.addEventListener('click', ()=> {
      initAudio();
      if (!audioSource) return;
      audioSource.gain.gain.setTargetAtTime(0.02, audioCtx.currentTime, 0.1);
      isPlaying = true;
      audioPlay.style.opacity = 0.6;
    });

    audioPause.addEventListener('click', ()=> {
      if (!audioSource) return;
      audioSource.gain.gain.setTargetAtTime(0.0, audioCtx.currentTime, 0.5);
      isPlaying = false;
      audioPlay.style.opacity = 1;
    });

    // Guided breathing logic
    const startBreath = document.getElementById('startBreath');
    const breathOverlay = document.getElementById('breathOverlay');
    const breathCircle = document.getElementById('breathCircle');
    const breathText = document.getElementById('breathText');
    const sessionTime = document.getElementById('sessionTime');
    const calmness = document.getElementById('calmness');

    let breathInterval, breathPhase = 0, breathStartTime = 0, sessionSeconds = 0, moodScore = 0;

    // breathing cycle: inhale (4s) hold (2s) exhale (6s) => 12s full
    const cycle = [
      {phase:'Inhale', dur:4000, scale:1.35},
      {phase:'Hold',   dur:2000, scale:1.35},
      {phase:'Exhale', dur:6000, scale:0.7}
    ];

    function startGuided(durationMinutes = 3) {
      if (breathInterval) stopGuided();
      breathOverlay.style.display = 'flex';
      breathPhase = 0; sessionSeconds = 0; moodScore = 0;
      breathStartTime = Date.now();
      updateSessionTime();
      // initial set
      applyBreathPhase(0);
      breathInterval = setInterval(()=> {
        sessionSeconds++;
        updateSessionTime();
        // every cycle step changes when its duration elapsed
        const now = Date.now();
        let elapsed = now - breathStartTime;
        // compute which phase we are in
        let phaseSum = 0; let chosen = 0, t = elapsed % (cycle[0].dur + cycle[1].dur + cycle[2].dur);
        for (let i=0;i<cycle.length;i++){
          phaseSum += cycle[i].dur;
          if (t <= phaseSum) { chosen = i; break; }
        }
        applyBreathPhase(chosen);
        // mood scoring: slight increment each full cycle completed
        if (elapsed > 0 && Math.floor(elapsed/12000) > 0) moodScore = Math.min(100, Math.floor((elapsed/12000) * 5));
        calmness.innerText = `${moodScore}%`;
      }, 1000);
      // stop after duration
      setTimeout(stopGuided, durationMinutes * 60 * 1000);
    }

    function applyBreathPhase(i) {
      const ph = cycle[i];
      breathText.innerText = ph.phase;
      breathCircle.style.transition = `transform ${ph.dur}ms ease-in-out`;
      breathCircle.style.transform = `scale(${ph.scale})`;
    }

    function stopGuided() {
      clearInterval(breathInterval);
      breathInterval = null;
      breathOverlay.style.display = 'none';
      breathCircle.style.transform = 'scale(1)';
      breathText.innerText = 'Good job';
    }

    startBreath.addEventListener('click', ()=> {
      // start 3-minute guided breathing
      startGuided(3);
    });

    function updateSessionTime() {
      const m = Math.floor(sessionSeconds / 60);
      const s = sessionSeconds % 60;
      sessionTime.innerText = `${m}:${s.toString().padStart(2,'0')}`;
    }

    // Attempt to show floating panel for XR users
    const panel = document.getElementById('panel');
    AFRAME.scenes[0].addEventListener('enter-vr', () => {
      panel.setAttribute('visible','true');
      // position panel in front of camera when entering VR
      const cam = document.querySelector('[camera]');
      if (cam) {
        const camPos = cam.object3D.getWorldPosition(new THREE.Vector3());
        panel.setAttribute('position', `${camPos.x} ${camPos.y-0.1} ${camPos.z - 0.8}`);
      }
    });
    AFRAME.scenes[0].addEventListener('exit-vr', () => panel.setAttribute('visible','false'));

    // Small nicety: keyboard shortcuts
    window.addEventListener('keydown', e => {
      if (e.key === '1') envSelect.value = 'beach', setEnv('beach');
      if (e.key === '2') envSelect.value = 'forest', setEnv('forest');
      if (e.key === '3') envSelect.value = 'night', setEnv('night');
      if (e.key === 'b') startGuided(3);
    });

    // Initialize calmness/opacities
    calmness.innerText = '0%';
  </script>
  <a href="home.html">Home</a>
</body>
</html>
